version: 0.2
env:
  variables:
    PIPELINE_STAGE: ""
phases:
  install:
    commands:
      - echo "Instalando dependencias..."
      - npm install -g newman
  build:
    commands:
      - |
        if [ "$PIPELINE_STAGE" = "build" ]; then
          echo "Inicio de la construcción en \`date\`"
          echo "Construyendo imagen de docker..."
          docker build -t nombre-de-tu-repositorio:latest .
          echo "Etiquetando imagen de docker..."
          docker tag nombre-de-tu-repositorio:latest 781000631387.dkr.ecr.us-east-2.amazonaws.com/nombre-de-tu-repositorio:latest
          echo "Creación de imagen completada en \`date\`"
          echo "Enviando imagen al repositorio de AWS..."
          docker push 781000631387.dkr.ecr.us-east-2.amazonaws.com/nombre-de-tu-repositorio:latest
          echo "Escribiendo el archivo de definición de la imagen..."
          printf '[{"name":"nombre-de-tu-contenedor","imageUri":"781000631387.dkr.ecr.us-east-2.amazonaws.com/nombre-de-tu-repositorio:latest"}]' > imageDefinitions.json
          printf '{"ImageURI":"nombre-de-tu-repositorio:latest"}' > imageDetail.json
          
          # Create the artifacts section directly as a YAML file.
          printf "artifacts:\n  files:\n    - imageDefinitions.json\n    - imageDetail.json\n    - taskdef.json\n    - appspec.json\n  name: BuildArtifact" > artifacts.yaml
          
        else
          echo "PIPELINE_STAGE no es build, omitiendo la creación de artefactos"
        fi
  post_build:
    commands:
      - |
        if [ "$PIPELINE_STAGE" = "test" ]; then
          echo "Ejecutando pruebas de aceptación con Postman y Newman..."
          newman run acceptance-test/blacklist-collection.postman_collection.json -e acceptance-test/fargate.postman_environment.json
          echo "Pruebas de aceptación completadas."
          
          # Create the artifacts section directly as a YAML file.
          printf "artifacts:\n  files: []\n  name: TestArtifact" > artifacts.yaml
        else
          echo "PIPELINE_STAGE no es test, omitiendo la creación de artefactos"
        fi
